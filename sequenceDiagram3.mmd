sequenceDiagram
    participant Manager
    participant CRM_FRONT
    participant CRM_BACK
    participant CRM_DB
    participant Task_Queue
    participant Worker
    participant GitHub
    participant CRM_ADMIN

    %% Загрузка данных для формы
    CRM_BACK->>CRM_FRONT: 0. {pibs, labels, milestone}   
    Note over CRM_FRONT: Данные для формы создания

    %% Создание задачи с валидацией
    Manager->>CRM_FRONT: 1. Заполняет форму
    CRM_FRONT->>CRM_BACK: 2. POST /tasks {manager_id, ...}
    
    alt Валидация успешна
        CRM_BACK->>CRM_DB: 3. Запись задачи
        CRM_DB-->>CRM_BACK: 4. {task_id, title, sync_status: "pending"}
        CRM_BACK-->>CRM_FRONT: 5. {task_id, title, sync_status: "pending"}
        CRM_FRONT-->>Manager: 6. "Задача {title} создана"
        
        %% Фоновая синхронизация
        CRM_BACK->>Task_Queue: 7. sync_github {task_id}
        Task_Queue->>Worker: 8. {task_id}
        
        %% Worker читает напрямую из БД
        Worker->>CRM_DB: 9. Получает данные задачи {task_id}
        CRM_DB-->>Worker: 10. Данные + GitHub token
        
        Worker->>GitHub: 11. POST /issues {title, body, labels}
        
        alt Успешно 201
            GitHub-->>Worker: 12. 201 {number: 456, url}
            Worker->>CRM_DB: 13. Обновляет: github_issue=456, sync_status="synced"
            Worker->>CRM_FRONT: 14. WebSocket: sync_complete {task_id, issue_number}
            CRM_FRONT-->>Manager: 15. Обновляет статус задачи (⚡→✅)
            
        else Ошибка GitHub API (4xx)
            GitHub-->>Worker: 12. Error {status, message}
            Worker->>CRM_DB: 13. Сохраняет ошибку: sync_status="error", error_details
            Worker->>CRM_ADMIN: 14. Уведомление о необходимости вмешательства
            
        else GitHub недоступен (5xx)
            GitHub-->>Worker: 12. 503 Service Unavailable
            Worker->>CRM_DB: 13. Обновляет: sync_status="retry", retry_count+1
            Worker->>Task_Queue: 14. Отложенный retry (+5 мин)
        end
        
    else Валидация не прошла
        CRM_BACK-->>CRM_FRONT: 4. 400 Validation Error
        CRM_FRONT-->>Manager: 5. "Ошибка: {details}"
    end